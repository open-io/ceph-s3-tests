name: ceph-s3-tests
version: v2.0

workflow:
  root:
    pipeline: root
    application: ceph-s3-tests

  mirror:
    pipeline: ceph-s3-tests-mirror
    application: ceph-s3-tests
    depends_on:
      - root
    conditions:
      check:
        - variable: cds.proj.mirror_to_github
          operator: eq
          value: "true"

  build:
    pipeline: ceph-s3-tests-build
    application: ceph-s3-tests
    depends_on:
      - root
    conditions:
      check:
        - variable: cds.triggered_by.username
          operator: ne
          value: "cds.scheduler"
        - variable: infra_id
          operator: eq
          value: ""

  ceph-s3-tests-infra2020:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra2020
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "2020"
    one_at_a_time: true
    optional: true

  ceph-s3-tests-infra3000:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra3000
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "3000"
    one_at_a_time: true
    optional: true

  ceph-s3-tests-infra3001:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra3001
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "3001"
    one_at_a_time: true
    optional: true

  ceph-s3-tests-infra4000:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra4000
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "4000"
    one_at_a_time: true
    optional: true

  ceph-s3-tests-infra4001:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra4001
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "4001"
    one_at_a_time: true
    optional: true

  ceph-s3-tests-infra4002:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra4002
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "4002"
    one_at_a_time: true
    optional: true

  ceph-s3-tests-infra4003:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra4003
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "4003"
    one_at_a_time: true
    optional: true

  ceph-s3-tests-infra4100:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra4100
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "4100"
    one_at_a_time: true
    optional: true

  ceph-s3-tests-infra400:
    pipeline: ceph-s3-tests
    application: ceph-s3-tests
    depends_on:
      - root
    environment: s3-tests-infra400
    conditions:
      check:
        - variable: infra_id
          operator: eq
          value: "400"
    one_at_a_time: true
    optional: true

retention_policy: "if(cds_triggered_by_username == 'cds.scheduler') then\n  return run_days_before < 1\nend\nif(has_git_branch == \"true\") then\n  if(git_branch_exist == \"true\") then    \n    return run_days_before < 365\n  else\n    return run_days_before < 2\n  end\nelse\n  return run_days_before < 365\nend"

metadata:
  default_tags: git.branch,git.author,git.tag,infra_id

notifications:
- type: vcs
  settings:
    on_success: always
    template:
      disable_comment: true

# run tests on all infra twice a day
hooks:
  root:

    - type: Scheduler
      name: Periodic tests on infra 3000
      config:
        cron: "3 0,12 * * *"
        timezone: UTC
      payload: '{"infra_id": "3000"}'

    - type: Scheduler
      name: Periodic tests on infra 3001
      config:
        cron: "2 1,13 * * *"
        timezone: UTC
      payload: '{"infra_id": "3001"}'

#    - type: Scheduler
#      name: Periodic tests on infra 3002
#      config:
#        cron: "7 2,14 * * *"
#        timezone: UTC
#      payload: '{"infra_id": "3002"}'

    - type: Scheduler
      name: Periodic tests on infra 4000
      config:
        cron: "9 3,15 * * *"
        timezone: UTC
      payload: '{"infra_id": "4000"}'

    - type: Scheduler
      name: Periodic tests on infra 4001
      config:
        cron: "11 4,16 * * *"
        timezone: UTC
      payload: '{"infra_id": "4001"}'

    - type: Scheduler
      name: Periodic tests on infra 4002
      config:
        cron: "13 5,17 * * *"
        timezone: UTC
      payload: '{"infra_id": "4002"}'

    - type: Scheduler
      name: Periodic tests on infra 4003
      config:
        cron: "15 6,18 * * *"
        timezone: UTC
      payload: '{"infra_id": "4003"}'

    - type: Scheduler
      name: Periodic tests on infra 4100
      config:
        cron: "17 7,19 * * *"
        timezone: UTC
      payload: '{"infra_id": "4100"}'

    - type: Scheduler
      name: Periodic tests on infra 400
      config:
        cron: "19 8,20 * * *"
        timezone: UTC
      payload: '{"infra_id": "400"}'
