version: v.10
name: ceph-s3-tests

jobs:
  - job: Run Ceph's S3 test suite
    always_executed: true
    steps:

      - name: Checkout application
        checkout: '{{ .cds.workspace }}'

      - name: Install dependencies
        script:
          - apt-get update
          - ./bootstrap
          - git submodule update --init --remote s3compat
          - rm -rf s3compat/ceph-tests
          - ln -s {{.cds.workspace}} s3compat/ceph-tests
          - . virtualenv/bin/activate
          - pip install -r s3compat/requirements.txt

      - name: Generate configuration file
        script: |+
          #!/bin/bash
          cd $HOME
          echo -n "Generating test configuration file: $HOME/autogenerated.conf "
          sed \
              -e s,%S3_SERVER%,{{.cds.env.s3_server}}, \
              -e s,%S3_PORT%,{{.cds.env.s3_port}}, \
              -e s,%S3_PROJECT_NAME%,{{.cds.env.s3_project_name}}, \
              -e s,%U0_ACCESS%,{{.cds.env.u0_access}}, \
              -e s,%U0_SECRET%,{{.cds.env.u0_secret}}, \
              -e s,%U1_ACCESS%,{{.cds.env.u1_access}}, \
              -e s,%U1_SECRET%,{{.cds.env.u1_secret}}, \
              ceph-s3-tests.conf.in \
              > "$HOME/autogenerated.conf"
          [ -f autogenerated.conf ] && echo "OK" || echo "Failed"

          echo -n "Generating awscli credentials file: $HOME/.aws/credentials "
          mkdir -p "$HOME/.aws"
          cat <<EOF > "$HOME/.aws/credentials"
          [default]
          aws_access_key_id=demo:demo
          aws_secret_access_key=DEMO_PASS
          region={{.cds.env.s3_region}}

          [s3-tests-admin]
          aws_access_key_id={{.cds.env.u0_access}}
          aws_secret_access_key={{.cds.env.u0_secret}}
          region={{.cds.env.s3_region}}

          [s3-tests-user1]
          aws_access_key_id={{.cds.env.u1_access}}
          aws_secret_access_key={{.cds.env.u1_secret}}
          region={{.cds.env.s3_region}}
          EOF
          [ -f "$HOME/.aws/credentials" ] && echo "OK" || echo "Failed"

          echo -n "Generating awscli configuration file: $HOME/.aws/config "
          cat <<EOF > "$HOME/.aws/config"
          [default]
          region = {{.cds.env.s3_region}}
          s3 =
              addressing_style = virtual
              max_concurrent_requests = 10
              max_queue_size = 100
              multipart_threshold = 15MB
              multipart_chunksize = 5MB
              signature_version = s3v4

          [profile s3-tests-admin]
          region = {{.cds.env.s3_region}}
          s3 =
              addressing_style = virtual
              max_concurrent_requests = 10
              max_queue_size = 100
              multipart_threshold = 15MB
              multipart_chunksize = 5MB
              signature_version = s3v4

          [profile s3-tests-user1]
          region = {{.cds.env.s3_region}}
          s3 =
              addressing_style = virtual
              max_concurrent_requests = 10
              max_queue_size = 100
              multipart_threshold = 15MB
              multipart_chunksize = 5MB
              signature_version = s3v4
          EOF
          [ -f "$HOME/.aws/config" ] && echo "OK" || echo "Failed"

          echo -n "Generating nosetests configuration: $HOME/setup.cfg "
          cat <<EOF > "$HOME/setup.cfg"
          [nosetests]
          with-xunit=1
          failure-detail=1
          verbosity=1
          logging-level=INFO
          EOF
          [ -f "$HOME/setup.cfg" ] && echo "OK" || echo "Failed"


      - name: Run tests
        optional: true
        script:
          - cd $HOME
          - S3TEST_CONF=autogenerated.conf ./virtualenv/bin/nosetests -a '!fails_on_aws' --debug-log=debug.log -v --with-xunit --xunit-file=tests_report.xml s3tests_boto3.functional.test_s3

      - name: Analyze tests results
        optional: true
        script:
          - . virtualenv/bin/activate
          - ./s3compat/bin/get_ceph_test_attributes.py
          - ./s3compat/bin/report.py -kf "known-failures/{{.infra_id}}.yaml" --detailed s3compat/output/ceph-s3.out.yaml "tests_report.xml" | tee tests_report.txt

      - name: Save tests report
        optional: true
        script:
          - "worker upload --tag='{{.cds.version}}' 'tests_report.xml' 'tests_report.txt'"
          - "[ -f debug.log ] && worker upload --tag='{{.cds.version}}' 'debug.log'"

      - optional: true
        always_executed: true
        jUnitReport: '{{.cds.workspace}}/tests_report.xml'

      - name: Cleanup
        optional: true
        script: |+
          #!/bin/bash
          . virtualenv/bin/activate
          pip install awscli
          ENDPOINT="https://{{.cds.env.s3_server}}:{{.cds.env.s3_port}}"
          python clean-all-buckets.py s3-tests-admin "$ENDPOINT"

    requirements:
      - model: Ubuntu-18.04-VM-b2-07
